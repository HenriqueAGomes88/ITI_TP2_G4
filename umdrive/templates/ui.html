<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>umDrive — Gestor de Ficheiros</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
:root {
  --accent: #0d6efd;
  --light-bg: #f8f9fa;
  --light-card: #ffffff;
  --dark-bg: #121212;
  --dark-card: #1e1e1e;
  --dark-item: #2a2a2a;
  --transition: all 0.3s ease-in-out;
}
body {
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--light-bg);
  color: #212529;
  transition: var(--transition);
}
body.dark {
  background-color: var(--dark-bg);
  color: #f1f1f1;
}

/* Barra superior */
.navbar {
  background-color: var(--light-card);
  box-shadow: 0 0.3rem 0.8rem rgba(0,0,0,0.1);
  transition: var(--transition);
}
body.dark .navbar {
  background-color: var(--dark-card);
  color: #f1f1f1;
}
body.dark .navbar small,
body.dark .navbar span,
body.dark .navbar p {
  color: #ccc !important;
}

/* Cards */
.card {
  background-color: var(--light-card);
  border: none;
  border-radius: 10px;
  box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
  transition: var(--transition);
}
body.dark .card {
  background-color: var(--dark-card);
  color: #f1f1f1;
}
body.dark .card .text-muted {
  color: #ccc !important;
}

/* Área de upload */
.dropzone {
  border: 2px dashed var(--accent);
  border-radius: 8px;
  text-align: center;
  padding: 2rem;
  color: #6c757d;
  transition: var(--transition);
  background-color: rgba(255,255,255,0.5);
}
body.dark .dropzone {
  color: #bbb;
  background-color: rgba(40,40,40,0.9);
  border-color: #66a3ff;
}
.dropzone.dragover {
  background: rgba(13,110,253,0.1);
}
.file-row:hover {
  background: rgba(13,110,253,0.1);
  border-radius: .5rem;
}
body.dark .file-row:hover {
  background: rgba(255,255,255,0.1);
}

/* Lista de ficheiros */
.list-group-item {
  background-color: var(--light-card);
  border: none;
  border-bottom: 1px solid #ddd;
  color: inherit;
}
body.dark .list-group-item {
  background-color: var(--dark-item);
  color: #f1f1f1;
  border-bottom: 1px solid #333;
}

/* Campos de input e seleção */
input.form-control, select.form-select {
  background-color: var(--light-card);
  color: #212529;
  border: 1px solid #ced4da;
  transition: var(--transition);
}
body.dark input.form-control, 
body.dark select.form-select {
  background-color: var(--dark-item);
  color: #f1f1f1;
  border: 1px solid #444;
}
body.dark input::placeholder {
  color: #aaa;
}

/* Toggle */
.toggle-switch {
  cursor: pointer;
  font-size: 1.4rem;
  color: var(--accent);
  transition: var(--transition);
}
body.dark .toggle-switch {
  color: #66a3ff;
}

.truncate {
  max-width: 40ch;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: inline-block;
}
</style>

</head>
<body>
<nav class="navbar navbar-light px-3 d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center gap-2">
    <i class="bi bi-cloud-fill text-primary fs-4"></i>
    <div>
      <strong>umDrive</strong><br><small class="text-muted">Gestor de ficheiros</small>
    </div>
  </div>
  <div class="d-flex align-items-center gap-3">
    <a href="/swagger" target="_blank" class="btn btn-outline-secondary btn-sm"><i class="bi bi-card-text"></i> API</a>
    <i id="themeToggle" class="bi bi-moon-stars-fill toggle-switch"></i>
  </div>
</nav>

<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card p-3">
        <h5><i class="bi bi-upload me-2 text-primary"></i>Enviar ficheiro</h5>
        <div id="dropzone" class="dropzone mt-2">
          <i class="bi bi-cloud-arrow-up fs-2 d-block mb-2"></i>
          <p class="mb-1">Arrasta ou clica</p>
          <p class="small">Tamanho máximo: 1 GB</p>
          <input id="fileInput" type="file" class="form-control d-none"/>
          <button id="chooseBtn" class="btn btn-primary btn-sm mt-2"><i class="bi bi-folder-plus"></i> Escolher</button>
          <div class="progress mt-3" style="height:1rem; display:none;" id="progressWrapper">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
          </div>
          <div id="uploadMsg" class="mt-2 small"></div>
        </div>
      </div>
      <div class="card mt-4 p-3">
        <h6><i class="bi bi-info-circle me-2 text-primary"></i>Informações</h6>
        <p class="small text-muted">Interface interativa. Usa os botões para descarregar ou apagar ficheiros.</p>
        <div class="d-flex gap-2">
          <button id="refreshBtn" class="btn btn-outline-primary btn-sm"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
          <button id="clearStorageBtn" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i> Apagar todos</button>
        </div>
      </div>
    </div>
    <div class="col-lg-8">
      <div class="card p-3">
        <div class="d-flex mb-3 gap-2">
          <input id="searchInput" type="search" class="form-control" placeholder="Procurar ficheiros...">
        </div>
        <div id="filesList" class="list-group small"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const fileInput=document.getElementById('fileInput');
const chooseBtn=document.getElementById('chooseBtn');
const dropzone=document.getElementById('dropzone');
const progressWrapper=document.getElementById('progressWrapper');
const progressBar=document.getElementById('progressBar');
const uploadMsg=document.getElementById('uploadMsg');
const filesList=document.getElementById('filesList');
const refreshBtn=document.getElementById('refreshBtn');
const themeToggle=document.getElementById('themeToggle');

// --- Tema persistente ---
if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
themeToggle.addEventListener('click',()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('theme', document.body.classList.contains('dark')?'dark':'light');
});

// --- Upload ---
chooseBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',()=>handleFiles(fileInput.files));
['dragenter','dragover'].forEach(e=>dropzone.addEventListener(e,ev=>{ev.preventDefault();dropzone.classList.add('dragover');}));
['dragleave','drop'].forEach(e=>dropzone.addEventListener(e,ev=>{ev.preventDefault();dropzone.classList.remove('dragover');}));
dropzone.addEventListener('drop',ev=>{
  const dt=ev.dataTransfer;
  if(dt&&dt.files&&dt.files.length) handleFiles(dt.files);
});

async function handleFiles(files) {
  if (!files.length) return;
  const file = files[0];
  try {
    await uploadSingleFile(file);
    fileInput.value = '';
    // aguarda 1 segundo para garantir que o servidor atualiza
    setTimeout(() => loadFiles(), 800);
  } catch (err) {
    uploadMsg.textContent = '❌ Erro no upload';
    console.error(err);
  }
}

async function uploadSingleFile(file) {
  uploadMsg.textContent = '';
  progressWrapper.style.display = 'block';
  progressBar.style.width = '0%';
  progressBar.textContent = '0%';

  const fd = new FormData();
  fd.append('file', file);

  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/files');

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = pct + '%';
        progressBar.textContent = pct + '%';
      }
    };

    xhr.onload = () => {
      // sucesso verdadeiro apenas se status for 200–299
      if (xhr.status >= 200 && xhr.status < 300) {
        uploadMsg.textContent = '✅ Upload concluído com sucesso!';
        setTimeout(() => {
          progressWrapper.style.display = 'none';
          progressBar.style.width = '0%';
          progressBar.textContent = '0%';
          loadFiles();
        }, 700);
        resolve();
      } else {
        console.error('Erro no upload:', xhr.status, xhr.responseText);
        uploadMsg.textContent = `⚠️ Erro no upload (HTTP ${xhr.status})`;
        reject();
      }
    };

    xhr.onerror = () => {
      uploadMsg.textContent = '❌ Erro de rede — servidor inacessível.';
      reject();
    };

    xhr.send(fd);
  });
}


// --- Listagem ---
async function loadFiles(){
  try{
    const res=await fetch('/api/files');
    const files=await res.json();
    renderFiles(files);
  }catch(err){
    filesList.innerHTML='<div class="list-group-item">Erro ao carregar ficheiros</div>';
  }
}
function renderFiles(files){
  const q=document.getElementById('searchInput').value.trim().toLowerCase();
  let arr=files.filter(f=>f.name.toLowerCase().includes(q));
  filesList.innerHTML='';
  if(!arr.length){filesList.innerHTML='<div class="list-group-item text-center text-muted">Sem ficheiros</div>';return;}
  arr.forEach(f=>{
    const item=document.createElement('div');
    item.className='list-group-item d-flex justify-content-between align-items-center file-row';
    item.innerHTML=`
      <div>
        <i class="bi bi-file-earmark-fill text-primary me-2"></i>
        <span class="truncate">${f.name}</span>
        <small class="text-muted d-block">${(f.size/1024).toFixed(1)} KB • ${new Date(f.mtime*1000).toLocaleString()}</small>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-success btn-sm" href="${f.download_url}" download><i class="bi bi-download"></i></a>
        <button class="btn btn-outline-danger btn-sm" data-del="${encodeURIComponent(f.name)}"><i class="bi bi-trash"></i></button>
      </div>`;
    filesList.appendChild(item);
  });
  filesList.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick=async()=>{
      const name=decodeURIComponent(btn.getAttribute('data-del'));
      if(!confirm('Apagar '+name+'?'))return;
      const r=await fetch('/api/files/'+encodeURIComponent(name),{method:'DELETE'});
      if (r.ok) {
        loadFiles();
      } else {
        const msg = await r.text();
        alert(`⚠️ Erro ao apagar (HTTP ${r.status})\n${msg}`);
      }
    };
  });
}
refreshBtn.addEventListener('click',loadFiles);
document.getElementById('searchInput').addEventListener('input',loadFiles);
loadFiles();
</script>
</body>
</html>